<!-- =========================================================================
     Path: frontend/src/app/features/sequence-box/sequence-box.component.html
     Version: v2.8.0
     ========================================================================= -->
<div class="card">
  <div class="card-header">
    <div class="title">Sequence</div>
    <div class="meta">
      <span>Length: {{ a.length() }} bp</span>
      <span *ngIf="hasInvalid()"> • non-DNA chars: {{ invalidCount() }}</span>
      <span *ngIf="a.selectedKind()"> • selected: {{ a.selectedKind() }} ({{ selRanges().length }} merged)</span>
      <span> • cursor: {{ cursorPos() + 1 }}</span>
      <span *ngIf="a.sequenceReferenceInfo() as ref"> • {{ referenceLabel(ref) }}</span>
    </div>
  </div>

  <div class="controls">
    <label class="hide-all">
      <input type="checkbox" [checked]="hideAllWhenSelected()" (change)="onHideAllToggle($event)">
      Hide “All ranges” bar when a single range is selected
    </label>

    <div class="right-controls">
      <label class="upload">
        <input type="file" accept=".fa,.fasta,.txt" (change)="onFastaFile($event)">
        Upload FASTA
      </label>
      <span class="cols">Per-line: {{ lineWidth() }} nt</span>
    </div>
  </div>

  <div class="design-overlay-controls" *ngIf="a.designLevelStats().length">
    <div class="overlay-field">
      <label for="designOverlayLevel">Design overlay</label>
      <select id="designOverlayLevel"
              [value]="a.designOverlayLevel() ?? ''"
              (change)="onDesignLevelChange($event)"
              [disabled]="!a.designOverlayControlsEnabled()">
        <option value="">None</option>
        <option *ngFor="let stat of a.designLevelStats()"
                [value]="stat.level">
          {{ overlayOptionLabel(stat) }}
        </option>
      </select>
    </div>
    <div class="overlay-field">
      <label for="designOverlayMode">Show</label>
      <select id="designOverlayMode"
              [value]="a.designOverlayMode()"
              (change)="onDesignModeChange($event)"
              [disabled]="!a.designOverlayControlsEnabled() || a.designOverlayLevel() === null">
        <option value="fragments">Fragments</option>
        <option value="oligos">Oligos</option>
      </select>
    </div>
    <button class="overlay-clear"
            type="button"
            (click)="clearDesignOverlaySelection()"
            [disabled]="!a.designOverlayControlsEnabled() || a.designOverlayLevel() === null">
      Hide overlay
    </button>
    <div class="overlay-legend" *ngIf="a.designOverlayVisible()">
      <span><span class="swatch sense"></span>Sense (+)</span>
      <span><span class="swatch antisense"></span>Antisense (-)</span>
    </div>
    <div class="overlay-warning"
         *ngIf="a.designOverlayAvailable() && !a.designOverlayControlsEnabled()">
      {{ a.designOverlayDisabledReason() || 'Design overlay unavailable for this sequence.' }}
    </div>
  </div>

  <div class="fragment-details" *ngIf="a.designFragmentSelection() as frag">
    <div class="details-header">
      {{ fragmentLabel(frag) }} {{ frag.id }}
      <span class="badge" *ngIf="frag.isOligo">Oligo</span>
      <span class="badge secondary" *ngIf="!frag.isOligo">Fragment</span>
    </div>
    <div class="details-grid">
      <div>Level</div>
      <div>L{{ frag.level }}</div>
      <div>Strand</div>
      <div>{{ frag.strand }}</div>
      <div>Length</div>
      <div>{{ frag.length }} bp</div>
      <div>Coordinates</div>
      <div>{{ frag.start + 1 }} – {{ frag.end }}</div>
      <div>Left overlap</div>
      <div>{{ frag.overlapPrev.length || 0 }} bp · {{ formatTm(frag.overlapPrevTm) }}</div>
      <div>Right overlap</div>
      <div>{{ frag.overlapNext.length || 0 }} bp · {{ formatTm(frag.overlapNextTm) }}</div>
    </div>
  </div>

  <div #viz class="viz" tabindex="0"
       (click)="focusViz()"
       (keydown)="onVizKeydown($event)"
       (paste)="onVizPaste($event)"
       (copy)="onVizCopy($event)">
    <ng-container *ngIf="a.sequence(); else empty">
      <div class="line" *ngFor="let ln of lines()">
        <!-- Bases (selection handled here) -->
        <div class="grid mono"
             [style.gridTemplateColumns]="'repeat(' + ln.cells.length + ', 1ch)'">
          <span *ngFor="let c of ln.cells"
                [class]="c.cls"
                [class.sel]="isSelected(c.abs)"
                (mousedown)="onCellMouseDown(c.abs, $event.shiftKey)"
                (mouseenter)="onCellMouseEnter(c.abs)"
                (click)="onCellClick(c.abs)">
            {{ c.ch }}
          </span>
        </div>

        <!-- CARET overlay (absolute, sits over the base row) -->
        <div class="caret grid mono"
             [style.gridTemplateColumns]="'repeat(' + ln.caret.length + ', 1ch)'">
          <span *ngFor="let on of ln.caret" class="caretcell" [class.on]="on"></span>
        </div>

        <!-- Short ticks -->
        <div class="grid mono tick"
             [style.gridTemplateColumns]="'repeat(' + ln.tick.length + ', 1ch)'">
          <span *ngFor="let on of ln.tick" class="tickcell" [class.on]="on"></span>
        </div>

        <!-- Numeric ruler -->
        <div class="grid mono ruler"
             [style.gridTemplateColumns]="'repeat(' + ln.ruler.length + ', 1ch)'">
          <span *ngFor="let r of ln.ruler" class="r"> {{ r }} </span>
        </div>

        <!-- All ranges -->
        <div class="grid bars"
             *ngIf="!(hideAllWhenSelected() && selRange())"
             [style.gridTemplateColumns]="'repeat(' + ln.barAll.length + ', 1ch)'">
          <span *ngFor="let on of ln.barAll" class="barcell"
                [style.background]="on ? barColorAll() : 'transparent'"></span>
        </div>

        <!-- Design overlay: sense -->
        <div class="grid bars design sense"
             *ngIf="a.designOverlayVisible() && ln.senseSegments.length"
             [style.gridTemplateColumns]="'repeat(' + ln.len + ', 1ch)'">
          <button type="button"
                  *ngFor="let seg of ln.senseSegments"
                  class="barcell segment"
                  [class.selected]="a.designFragmentSelection()?.id === seg.fragment.id"
                  [style.gridColumn]="(seg.startCol + 1) + ' / ' + (seg.endCol + 1)"
                  [style.background]="senseBarColor"
                  [title]="segmentTooltip(seg.fragment)"
                  [attr.data-frag-label]="seg.fragment.id"
                  [attr.aria-label]="segmentTooltip(seg.fragment)"
                  (click)="onFragmentSegmentClick(seg.fragment, $event)">
          </button>
        </div>

        <!-- Design overlay: antisense -->
        <div class="grid bars design antisense"
             *ngIf="a.designOverlayVisible() && ln.antisenseSegments.length"
             [style.gridTemplateColumns]="'repeat(' + ln.len + ', 1ch)'">
          <button type="button"
                  *ngFor="let seg of ln.antisenseSegments"
                  class="barcell segment"
                  [class.selected]="a.designFragmentSelection()?.id === seg.fragment.id"
                  [style.gridColumn]="(seg.startCol + 1) + ' / ' + (seg.endCol + 1)"
                  [style.background]="antisenseBarColor"
                  [title]="segmentTooltip(seg.fragment)"
                  [attr.data-frag-label]="seg.fragment.id"
                  [attr.aria-label]="segmentTooltip(seg.fragment)"
                  (click)="onFragmentSegmentClick(seg.fragment, $event)">
          </button>
        </div>

        <!-- Selected range -->
        <div class="grid bars sel"
             [style.gridTemplateColumns]="'repeat(' + ln.barSel.length + ', 1ch)'">
          <span *ngFor="let on of ln.barSel" class="barcell"
                [style.background]="on ? barColorSel() : 'transparent'"></span>
        </div>
      </div>
    </ng-container>
    <ng-template #empty>
      <div class="placeholder">Click here and type/paste DNA (A C G T)… or upload FASTA above.</div>
    </ng-template>
  </div>
</div>
